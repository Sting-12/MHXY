import tkinter as tk
from tkinter import ttk, messagebox
import pandas as pd
from datetime import datetime
import os
import threading
import time
import queue
import sys

class YakshaCounter:
    def __init__(self, root):
        self.root = root
        self.root.title("夜叉妖王统计")
        self.root.geometry("600x800")
        self.root.resizable(True, True)
        self.root.minsize(450, 600)

        # 初始化数据
        self.today = datetime.now().strftime("%Y%m%d")
        self.data_dir = "yaksha_data"
        os.makedirs(self.data_dir, exist_ok=True)
        self.data_file = os.path.join(self.data_dir, f"{self.today}_data.xlsx")
        self.timer_file = os.path.join(self.data_dir, f"{self.today}_timer.txt")

        # 统计数据结构
        self.stats = {
            'nightmare': {
                '画魂': 0,
                '万年': 0,
                '变异炎魔神': 0,
                '变异夜罗刹': 0,
                '变异吸血鬼': 0,
                '变异鬼将': 0,
                '变异幽灵': 0,
                '一黄': 0,
                '二黄': 0,
                '三黄': 0,
                '四黄': 0,
                '五黄': 0,
                '绿龟': 0
            },
            'demon': {
                '龙一': 0,
                '凤一': 0,
                '女娲': 0,
                '小西天': 0
            }
        }

        # 撤回历史记录
        self.history = []
        self.history_limit = 50

        # 计时器相关
        self.timer_running = False
        self.start_time = 0
        self.elapsed_time = 0
        self.timer_update_id = None
        self.total_time_var = tk.StringVar(value="今日游戏时长: 00:00:00")

        # 加载数据
        self.load_today_data()
        self.load_timer_data()

        # 创建界面
        self.create_widgets()

    def load_today_data(self):
        """加载今日数据"""
        try:
            if os.path.exists(self.data_file):
                df = pd.read_excel(self.data_file, index_col=0)
                for category in self.stats:
                    for item in self.stats[category]:
                        if item in df.index:
                            self.stats[category][item] = int(df.loc[item, 'count'])
        except Exception as e:
            print(f"加载数据失败: {e}")

    def save_today_data(self):
        """保存今日数据"""
        try:
            data = []
            for category in self.stats:
                for item, count in self.stats[category].items():
                    data.append({'item': item, 'category': category, 'count': count})
            df = pd.DataFrame(data).set_index('item')
            df.to_excel(self.data_file)
        except Exception as e:
            print(f"保存数据失败: {e}")

    def load_timer_data(self):
        """加载计时器数据"""
        try:
            if os.path.exists(self.timer_file):
                with open(self.timer_file, 'r') as f:
                    self.elapsed_time = float(f.read().strip())
                self.update_total_time_display()
        except Exception as e:
            print(f"加载计时器数据失败: {e}")

    def save_timer_data(self):
        """保存计时器数据"""
        try:
            with open(self.timer_file, 'w') as f:
                f.write(str(self.elapsed_time))
        except Exception as e:
            print(f"保存计时器数据失败: {e}")

    def on_year_select(self, value):
        """处理万年下拉菜单选择"""
        if value == "万年":
            self.increment_count('nightmare', '万年')
        else:
            self.increment_count('nightmare', value)
        self.var_year.set("万年")

    def increment_count(self, category, item):
        """增加计数"""
        self.save_history()
        self.stats[category][item] += 1
        self.update_display()
        self.save_today_data()

    def save_history(self):
        """保存当前状态到历史记录"""
        current_state = {
            'nightmare': self.stats['nightmare'].copy(),
            'demon': self.stats['demon'].copy()
        }
        self.history.append(current_state)
        if len(self.history) > self.history_limit:
            self.history.pop(0)

    def undo_last_action(self):
        """撤回上一步操作"""
        if not self.history:
            messagebox.showinfo("提示", "没有可撤回的操作")
            return
        last_state = self.history.pop()
        self.stats['nightmare'] = last_state['nightmare'].copy()
        self.stats['demon'] = last_state['demon'].copy()
        self.update_display()
        self.save_today_data()
        messagebox.showinfo("成功", "已撤回上一步操作")

    def start_timer(self):
        """开始计时"""
        if not self.timer_running:
            self.timer_running = True
            self.start_time = time.time() - self.elapsed_time
            self.update_timer()

    def stop_timer(self):
        """暂停计时"""
        if self.timer_running:
            self.timer_running = False
            if self.timer_update_id:
                self.root.after_cancel(self.timer_update_id)
                self.timer_update_id = None
            self.save_timer_data()

    def reset_timer(self):
        """重置计时器"""
        self.timer_running = False
        self.elapsed_time = 0
        self.start_time = 0
        if self.timer_update_id:
            self.root.after_cancel(self.timer_update_id)
            self.timer_update_id = None
        self.update_timer_display()
        self.save_timer_data()

    def reset_today(self):
        """重置今日数据"""
        if messagebox.askyesno("确认", "确定要重置今日所有统计数据吗？"):
            self.save_history()
            for category in self.stats:
                for item in self.stats[category]:
                    self.stats[category][item] = 0
            self.elapsed_time = 0
            if self.timer_running:
                self.stop_timer()
            self.update_display()
            self.save_today_data()
            self.save_timer_data()
        if self.timer_update_id:
            self.root.after_cancel(self.timer_update_id)
            self.timer_update_id = None
        self.update_timer_display()
        self.save_timer_data()

    def update_timer(self):
        """更新计时器显示"""
        if self.timer_running:
            self.elapsed_time = time.time() - self.start_time
            self.update_timer_display()
            self.timer_update_id = self.root.after(1000, self.update_timer)

    def update_timer_display(self):
        """更新计时器显示"""
        hours = int(self.elapsed_time // 3600)
        minutes = int((self.elapsed_time % 3600) // 60)
        seconds = int(self.elapsed_time % 60)
        time_str = f"{hours:02d}:{minutes:02d}:{seconds:02d}"
        self.timer_var.set(f"当前计时: {time_str}")
        self.total_time_var.set(f"今日游戏时长: {time_str}")
        
        if self.timer_running:
            self.timer_status_var.set("状态: 计时中...")
        else:
            self.timer_status_var.set("状态: 已暂停")

    def update_total_time_display(self):
        """更新总时长显示"""
        hours = int(self.elapsed_time // 3600)
        minutes = int((self.elapsed_time % 3600) // 60)
        seconds = int(self.elapsed_time % 60)
        time_str = f"{hours:02d}:{minutes:02d}:{seconds:02d}"
        self.total_time_var.set(f"今日游戏时长: {time_str}")

    def show_donate_qr(self):
        """显示打赏二维码"""
        qr_window = tk.Toplevel(self.root)
        qr_window.title("打赏支持")
        qr_window.resizable(False, False)

        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        x = (screen_width // 2) - (400 // 2)
        y = (screen_height // 2) - (500 // 2)
        qr_window.geometry(f"400x500+{x}+{y}")

        title_label = ttk.Label(qr_window, text="感谢使用本工具！", font=('微软雅黑', 14, 'bold'))
        title_label.pack(pady=(20, 10))

        desc_label = ttk.Label(qr_window, text="如果本工具对你有帮助，可以请开发者喝杯咖啡哦！",
                              font=('微软雅黑', 10), justify=tk.CENTER)
        desc_label.pack(pady=(0, 20))

        try:
            from PIL import Image, ImageTk
            import requests
            from io import BytesIO
        except ImportError as e:
            raise Exception(f"缺少必要的库: {e}\n请运行: pip install pillow requests")

        try:
            qr_url = "https://space.coze.cn/s/00d6GB0dzcI/?width_height=570x517"

            print(f"[DEBUG] 尝试下载图片: {qr_url}")

            success = False
            last_error = None

            for attempt in range(3):
                try:
                    print(f"[DEBUG] 第 {attempt + 1} 次尝试...")
                    response = requests.get(qr_url, timeout=10)

                    print(f"[DEBUG] HTTP状态码: {response.status_code}")
                    print(f"[DEBUG] Content-Type: {response.headers.get('Content-Type', 'unknown')}")

                    response.raise_for_status()

                    img_data = response.content
                    print(f"[DEBUG] 下载数据大小: {len(img_data)} bytes")

                    if b'<!DOCTYPE html>' in img_data or b'<html' in img_data:
                        raise Exception("URL 返回的是 HTML 页面，不是图片数据")

                    img = Image.open(BytesIO(img_data))
                    print(f"[DEBUG] 图片尺寸: {img.size}")
                    print(f"[DEBUG] 图片格式: {img.format}")

                    img.thumbnail((300, 300), Image.Resampling.LANCZOS)
                    photo = ImageTk.PhotoImage(img)

                    qr_label = ttk.Label(qr_window, image=photo)
                    qr_label.image = photo
                    qr_label.pack(pady=(0, 10))

                    success = True
                    print("[DEBUG] 图片显示成功！")
                    break

                except Exception as e:
                    last_error = e
                    print(f"[DEBUG] 第 {attempt + 1} 次尝试失败: {e}")
                    import traceback
                    traceback.print_exc()
                    time.sleep(0.5)
                    continue

            if not success:
                raise Exception(f"图片加载失败（已重试3次）: {last_error}")

        except Exception as e:
            print(f"[ERROR] 加载图片失败: {e}")
            import traceback
            traceback.print_exc()

            error_frame = ttk.LabelFrame(qr_window, text="图片加载失败", padding="10")
            error_frame.pack(fill=tk.X, padx=20, pady=(0, 10))

            error_label = ttk.Label(error_frame, text=f"错误信息:\n{str(e)}",
                                    font=('微软雅黑', 9), foreground='red', justify=tk.LEFT)
            error_label.pack(pady=(5, 10))

            link_label = ttk.Label(error_frame, text="请手动访问以下链接查看收款码:",
                                   font=('微软雅黑', 10, 'bold'))
            link_label.pack(pady=(5, 0))

            url_label = ttk.Label(error_frame,
                                  text="https://space.coze.cn/s/00d6GB0dzcI/?width_height=570x517",
                                  font=('微软雅黑', 8), foreground='blue',
                                  cursor="hand2", wraplength=300)
            url_label.pack(pady=(0, 10))

            def copy_url():
                qr_window.clipboard_clear()
                qr_window.clipboard_append("https://space.coze.cn/s/00d6GB0dzcI/?width_height=570x517")
                qr_window.update()
                messagebox.showinfo("提示", "链接已复制到剪贴板！\n请在浏览器中打开查看")

            copy_btn = ttk.Button(error_frame, text="复制图片链接", command=copy_url)
            copy_btn.pack(pady=(0, 5))

            def open_url(event):
                import webbrowser
                webbrowser.open("https://space.coze.cn/s/00d6GB0dzcI/?width_height=570x517")

            url_label.bind("<Double-Button-1>", open_url)
            url_label.pack()

            hint_label = ttk.Label(error_frame, text="(双击链接可直接在浏览器中打开)",
                                   font=('微软雅黑', 8), foreground='gray')
            hint_label.pack(pady=(0, 10))

            backup_label = ttk.Label(qr_window,
                                   text="如仍无法查看，请联系开发者获取收款码",
                                   font=('微软雅黑', 9), foreground='gray')
            backup_label.pack(pady=(0, 10))

        close_btn = ttk.Button(qr_window, text="关闭", command=qr_window.destroy)
        close_btn.pack(pady=(0, 20))

    def update_display(self):
        """更新界面显示"""
        # 更新梦魇夜叉统计
        for item in self.stats['nightmare']:
            if item in self.nightmare_vars:
                self.nightmare_vars[item].set(f"{self.stats['nightmare'][item]}次")

        # 更新万年总计
        year_total = (
            self.stats['nightmare']['万年'] +
            self.stats['nightmare']['变异炎魔神'] +
            self.stats['nightmare']['变异夜罗刹'] +
            self.stats['nightmare']['变异吸血鬼'] +
            self.stats['nightmare']['变异鬼将'] +
            self.stats['nightmare']['变异幽灵']
        )
        self.year_total_var.set(f"总计: {year_total}次")

        # 更新妖王统计
        for item in self.stats['demon']:
            self.demon_vars[item].set(f"{self.stats['demon'][item]}次")

        # 更新总计
        total_nightmare = sum(self.stats['nightmare'].values())
        yellow_total = sum(self.stats['nightmare'][item] for item in ['一黄', '二黄', '三黄', '四黄', '五黄'])
        self.total_nightmare_var.set(f"总计: {total_nightmare}次 (其中黄怪: {yellow_total}次)")

        total_demon = sum(self.stats['demon'].values())
        self.total_demon_var.set(f"总计: {total_demon}次")

        grand_total = total_nightmare + total_demon
        self.grand_total_var.set(f"今日总计: {grand_total}次")

        # 更新变异怪物统计显示
        mutant_str = (
            f"变异统计: 炎魔神: {self.stats['nightmare']['变异炎魔神']}  "
            f"夜罗刹: {self.stats['nightmare']['变异夜罗刹']}  "
            f"吸血鬼: {self.stats['nightmare']['变异吸血鬼']}  "
            f"鬼将: {self.stats['nightmare']['变异鬼将']}  "
            f"幽灵: {self.stats['nightmare']['变异幽灵']}"
        )
        self.mutant_stats_var.set(mutant_str)

    def export_all_data(self):
        """导出所有数据"""
        try:
            all_data = []

            for file in os.listdir(self.data_dir):
                if file.endswith('_data.xlsx'):
                    date_str = file[:8]
                    file_path = os.path.join(self.data_dir, file)
                    df = pd.read_excel(file_path, index_col=0)

                    timer_path = os.path.join(self.data_dir, f"{date_str}_timer.txt")
                    timer_seconds = 0
                    if os.path.exists(timer_path):
                        with open(timer_path, 'r') as f:
                            timer_seconds = float(f.read().strip())

                    hours = int(timer_seconds // 3600)
                    minutes = int((timer_seconds % 3600) // 60)
                    seconds = int(timer_seconds % 60)
                    timer_str = f"{hours:02d}:{minutes:02d}:{seconds:02d}"

                    daily_data = {'日期': date_str}

                    daily_data['画魂'] = df.loc['画魂', 'count'] if '画魂' in df.index else 0
                    daily_data['万年'] = df.loc['万年', 'count'] if '万年' in df.index else 0
                    daily_data['变异炎魔神'] = df.loc['变异炎魔神', 'count'] if '变异炎魔神' in df.index else 0
                    daily_data['变异夜罗刹'] = df.loc['变异夜罗刹', 'count'] if '变异夜罗刹' in df.index else 0
                    daily_data['变异吸血鬼'] = df.loc['变异吸血鬼', 'count'] if '变异吸血鬼' in df.index else 0
                    daily_data['变异鬼将'] = df.loc['变异鬼将', 'count'] if '变异鬼将' in df.index else 0
                    daily_data['变异幽灵'] = df.loc['变异幽灵', 'count'] if '变异幽灵' in df.index else 0
                    daily_data['一黄'] = df.loc['一黄', 'count'] if '一黄' in df.index else 0
                    daily_data['二黄'] = df.loc['二黄', 'count'] if '二黄' in df.index else 0
                    daily_data['三黄'] = df.loc['三黄', 'count'] if '三黄' in df.index else 0
                    daily_data['四黄'] = df.loc['四黄', 'count'] if '四黄' in df.index else 0
                    daily_data['五黄'] = df.loc['五黄', 'count'] if '五黄' in df.index else 0
                    daily_data['绿龟'] = df.loc['绿龟', 'count'] if '绿龟' in df.index else 0

                    daily_data['龙一'] = df.loc['龙一', 'count'] if '龙一' in df.index else 0
                    daily_data['凤一'] = df.loc['凤一', 'count'] if '凤一' in df.index else 0
                    daily_data['女娲'] = df.loc['女娲', 'count'] if '女娲' in df.index else 0
                    daily_data['小西天'] = df.loc['小西天', 'count'] if '小西天' in df.index else 0

                    nightmare_total = sum([
                        daily_data['画魂'],
                        daily_data['万年'],
                        daily_data['变异炎魔神'],
                        daily_data['变异夜罗刹'],
                        daily_data['变异吸血鬼'],
                        daily_data['变异鬼将'],
                        daily_data['变异幽灵'],
                        daily_data['一黄'],
                        daily_data['二黄'],
                        daily_data['三黄'],
                        daily_data['四黄'],
                        daily_data['五黄'],
                        daily_data['绿龟']
                    ])

                    demon_total = sum([
                        daily_data['龙一'],
                        daily_data['凤一'],
                        daily_data['女娲'],
                        daily_data['小西天']
                    ])

                    daily_data['梦魇夜叉总计'] = nightmare_total
                    daily_data['妖王总计'] = demon_total
                    daily_data['当日总计'] = nightmare_total + demon_total
                    daily_data['游戏时长'] = timer_str

                    all_data.append(daily_data)

            if not all_data:
                messagebox.showinfo("提示", "没有可导出的数据")
                return

            df_all = pd.DataFrame(all_data)

            column_order = [
                '日期',
                '画魂',
                '万年', '变异炎魔神', '变异夜罗刹',
                '变异吸血鬼', '变异鬼将', '变异幽灵',
                '一黄', '二黄', '三黄', '四黄', '五黄', '绿龟',
                '梦魇夜叉总计',
                '龙一', '凤一', '女娲', '小西天',
                '妖王总计',
                '当日总计',
                '游戏时长'
            ]
            df_all = df_all[column_order]

            export_file = f"梦幻西游统计数据_{datetime.now().strftime('%Y%m%d')}.xlsx"

            with pd.ExcelWriter(export_file, engine='openpyxl') as writer:
                df_all.to_excel(writer, sheet_name='统计汇总', index=False)

                raw_data = []
                for file in os.listdir(self.data_dir):
                    if file.endswith('_data.xlsx'):
                        date_str = file[:8]
                        file_path = os.path.join(self.data_dir, file)
                        df = pd.read_excel(file_path, index_col=0)

                        for idx, row in df.iterrows():
                            raw_data.append({
                                '日期': date_str,
                                '类别': '梦魇夜叉' if row['category'] == 'nightmare' else '妖王',
                                '名称': idx,
                                '数量': row['count']
                            })

                if raw_data:
                    pd.DataFrame(raw_data).to_excel(writer, sheet_name='原始数据', index=False)
                else:
                    pd.DataFrame(columns=['日期', '类别', '名称', '数量']).to_excel(writer, sheet_name='原始数据', index=False)

            messagebox.showinfo("成功", f"数据已成功导出到: {export_file}")
        except Exception as e:
            messagebox.showerror("错误", f"导出数据失败: {str(e)}")
            import traceback
            traceback.print_exc()

    def create_widgets(self):
        """创建界面组件"""
        style = ttk.Style()
        style.configure('Title.TLabel', font=('微软雅黑', 16, 'bold'))
        style.configure('Section.TLabelframe.Label', font=('微软雅黑', 11, 'bold'))
        style.configure('Count.TLabel', font=('微软雅黑', 9))
        style.configure('Total.TLabel', font=('微软雅黑', 10, 'bold'))

        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.pack(fill=tk.BOTH, expand=True)

        title_frame = ttk.Frame(main_frame)
        title_frame.pack(fill=tk.X, pady=(0, 10))

        title_label = ttk.Label(title_frame, text="夜叉妖王统计", style='Title.TLabel')
        title_label.pack(side=tk.LEFT)

        donate_btn = ttk.Button(title_frame, text="提升龟率", command=self.show_donate_qr)
        donate_btn.pack(side=tk.RIGHT, padx=5)

        nightmare_frame = ttk.LabelFrame(main_frame, text="梦魇夜叉统计", padding="10")
        nightmare_frame.pack(fill=tk.X, pady=(0, 10))

        self.nightmare_vars = {}

        btn = ttk.Button(nightmare_frame, text="画魂",
                        command=lambda: self.increment_count('nightmare', '画魂'))
        btn.grid(row=0, column=0, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['画魂'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['画魂'],
                         style='Count.TLabel')
        label.grid(row=0, column=1, padx=5, pady=3, sticky='ew')

        self.var_year = tk.StringVar()
        self.var_year.set("万年")

        year_menu = ttk.OptionMenu(nightmare_frame, self.var_year, "万年",
                                  "万年", "变异炎魔神", "变异夜罗刹",
                                  "变异吸血鬼", "变异鬼将", "变异幽灵",
                                  command=self.on_year_select)
        year_menu.grid(row=0, column=2, padx=5, pady=3, sticky='ew')

        self.nightmare_vars['万年'] = tk.StringVar(value="0次")
        self.nightmare_vars['变异炎魔神'] = tk.StringVar(value="0次")
        self.nightmare_vars['变异夜罗刹'] = tk.StringVar(value="0次")
        self.nightmare_vars['变异吸血鬼'] = tk.StringVar(value="0次")
        self.nightmare_vars['变异鬼将'] = tk.StringVar(value="0次")
        self.nightmare_vars['变异幽灵'] = tk.StringVar(value="0次")

        self.year_total_var = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.year_total_var,
                         style='Count.TLabel')
        label.grid(row=0, column=3, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="一黄",
                        command=lambda: self.increment_count('nightmare', '一黄'))
        btn.grid(row=1, column=0, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['一黄'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['一黄'],
                         style='Count.TLabel')
        label.grid(row=1, column=1, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="二黄",
                        command=lambda: self.increment_count('nightmare', '二黄'))
        btn.grid(row=1, column=2, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['二黄'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['二黄'],
                         style='Count.TLabel')
        label.grid(row=1, column=3, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="三黄",
                        command=lambda: self.increment_count('nightmare', '三黄'))
        btn.grid(row=2, column=0, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['三黄'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['三黄'],
                         style='Count.TLabel')
        label.grid(row=2, column=1, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="四黄",
                        command=lambda: self.increment_count('nightmare', '四黄'))
        btn.grid(row=2, column=2, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['四黄'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['四黄'],
                         style='Count.TLabel')
        label.grid(row=2, column=3, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="五黄",
                        command=lambda: self.increment_count('nightmare', '五黄'))
        btn.grid(row=3, column=0, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['五黄'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['五黄'],
                         style='Count.TLabel')
        label.grid(row=3, column=1, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(nightmare_frame, text="绿龟",
                        command=lambda: self.increment_count('nightmare', '绿龟'))
        btn.grid(row=3, column=2, padx=5, pady=3, sticky='ew')
        self.nightmare_vars['绿龟'] = tk.StringVar(value="0次")
        label = ttk.Label(nightmare_frame, textvariable=self.nightmare_vars['绿龟'],
                         style='Count.TLabel')
        label.grid(row=3, column=3, padx=5, pady=3, sticky='ew')

        self.total_nightmare_var = tk.StringVar(value="总计: 0次 (其中黄怪: 0次)")
        total_label = ttk.Label(nightmare_frame, textvariable=self.total_nightmare_var,
                               style='Total.TLabel')
        total_label.grid(row=4, column=0, columnspan=4, pady=(10, 0))

        nightmare_frame.columnconfigure(0, weight=1)
        nightmare_frame.columnconfigure(1, weight=2)
        nightmare_frame.columnconfigure(2, weight=1)
        nightmare_frame.columnconfigure(3, weight=2)

        demon_frame = ttk.LabelFrame(main_frame, text="妖王统计", padding="10")
        demon_frame.pack(fill=tk.X, pady=(0, 10))

        self.demon_vars = {}

        btn = ttk.Button(demon_frame, text="龙一",
                        command=lambda: self.increment_count('demon', '龙一'))
        btn.grid(row=0, column=0, padx=5, pady=3, sticky='ew')
        self.demon_vars['龙一'] = tk.StringVar(value="0次")
        label = ttk.Label(demon_frame, textvariable=self.demon_vars['龙一'],
                         style='Count.TLabel')
        label.grid(row=0, column=1, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(demon_frame, text="凤一",
                        command=lambda: self.increment_count('demon', '凤一'))
        btn.grid(row=0, column=2, padx=5, pady=3, sticky='ew')
        self.demon_vars['凤一'] = tk.StringVar(value="0次")
        label = ttk.Label(demon_frame, textvariable=self.demon_vars['凤一'],
                         style='Count.TLabel')
        label.grid(row=0, column=3, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(demon_frame, text="女娲",
                        command=lambda: self.increment_count('demon', '女娲'))
        btn.grid(row=1, column=0, padx=5, pady=3, sticky='ew')
        self.demon_vars['女娲'] = tk.StringVar(value="0次")
        label = ttk.Label(demon_frame, textvariable=self.demon_vars['女娲'],
                         style='Count.TLabel')
        label.grid(row=1, column=1, padx=5, pady=3, sticky='ew')

        btn = ttk.Button(demon_frame, text="小西天",
                        command=lambda: self.increment_count('demon', '小西天'))
        btn.grid(row=1, column=2, padx=5, pady=3, sticky='ew')
        self.demon_vars['小西天'] = tk.StringVar(value="0次")
        label = ttk.Label(demon_frame, textvariable=self.demon_vars['小西天'],
                         style='Count.TLabel')
        label.grid(row=1, column=3, padx=5, pady=3, sticky='ew')

        self.total_demon_var = tk.StringVar(value="总计: 0次")
        total_label = ttk.Label(demon_frame, textvariable=self.total_demon_var,
                               style='Total.TLabel')
        total_label.grid(row=2, column=0, columnspan=4, pady=(10, 0))

        demon_frame.columnconfigure(0, weight=1)
        demon_frame.columnconfigure(1, weight=2)
        demon_frame.columnconfigure(2, weight=1)
        demon_frame.columnconfigure(3, weight=2)

        button_frame = ttk.Frame(main_frame)
        button_frame.pack(fill=tk.X, pady=10)

        button_frame.columnconfigure(0, weight=1)
        button_frame.columnconfigure(1, weight=1)
        button_frame.columnconfigure(2, weight=1)

        reset_btn = ttk.Button(button_frame, text="重置今日数据",
                             command=self.reset_today)
        reset_btn.grid(row=0, column=0, padx=5, pady=2, sticky='ew')

        export_btn = ttk.Button(button_frame, text="导出所有数据",
                              command=self.export_all_data)
        export_btn.grid(row=0, column=1, padx=5, pady=2, sticky='ew')

        undo_btn = ttk.Button(button_frame, text="撤回上一步",
                            command=self.undo_last_action)
        undo_btn.grid(row=0, column=2, padx=5, pady=2, sticky='ew')

        total_frame = ttk.LabelFrame(main_frame, text="总计信息", padding="10")
        total_frame.pack(fill=tk.X, pady=(10, 0))

        self.grand_total_var = tk.StringVar(value="今日总计: 0次")
        grand_total_label = ttk.Label(total_frame, textvariable=self.grand_total_var,
                                     font=('微软雅黑', 10, 'bold'))
        grand_total_label.pack(pady=(0, 5))

        total_time_label = ttk.Label(total_frame, textvariable=self.total_time_var,
                                     font=('微软雅黑', 10))
        total_time_label.pack(pady=(0, 10))

        self.mutant_stats_var = tk.StringVar(value="变异统计: 炎魔神: 0  夜罗刹: 0  吸血鬼: 0  鬼将: 0  幽灵: 0")
        mutant_label = ttk.Label(total_frame, textvariable=self.mutant_stats_var,
                                font=('微软雅黑', 10, 'bold'))
        mutant_label.pack()

        timer_frame = ttk.LabelFrame(main_frame, text="游戏计时器", padding="10")
        timer_frame.pack(fill=tk.X, pady=(10, 0))

        timer_btn_frame = ttk.Frame(timer_frame)
        timer_btn_frame.pack(fill=tk.X, pady=(5, 10))

        start_btn = ttk.Button(timer_btn_frame, text="开始",
                              command=self.start_timer)
        start_btn.pack(side=tk.LEFT, padx=2, expand=True, fill=tk.X)

        stop_btn = ttk.Button(timer_btn_frame, text="暂停",
                             command=self.stop_timer)
        stop_btn.pack(side=tk.LEFT, padx=2, expand=True, fill=tk.X)

        self.timer_var = tk.StringVar(value="当前计时: 00:00:00")
        timer_label = ttk.Label(timer_frame, textvariable=self.timer_var,
                               font=('微软雅黑', 12, 'bold'))
        timer_label.pack(pady=(0, 5))

        self.timer_status_var = tk.StringVar(value="状态: 已暂停")
        status_label = ttk.Label(timer_frame, textvariable=self.timer_status_var)
        status_label.pack()

        status_frame = ttk.Frame(main_frame)
        status_frame.pack(fill=tk.X, pady=(10, 0))

        date_label = ttk.Label(status_frame, text=f"今日日期: {self.today}")
        date_label.pack(side=tk.LEFT)

        version_label = ttk.Label(status_frame, text="Mr.Xxxxxxx 稳定版 v3.0 ")
        version_label.pack(side=tk.RIGHT)

        self.update_display()
        self.update_timer_display()

def main():
    """主函数"""
    try:
        root = tk.Tk()
        app = YakshaCounter(root)
        root.mainloop()
    except Exception as e:
        error_msg = f"程序启动失败: {str(e)}"
        print(error_msg, file=sys.stderr)
        try:
            root = tk.Tk()
            root.withdraw()
            messagebox.showerror("错误", error_msg)
        except:
            pass

if __name__ == "__main__":
    main()
